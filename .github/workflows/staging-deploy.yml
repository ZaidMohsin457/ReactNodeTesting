name: CI → Deploy to STAGING

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: ${{ secrets.NODE_VERSION || '18' }}

jobs:
  build-test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (root)
        run: |
          npm i

      - name: Run lint & tests (allow warnings)
        run: |
          npm run lint || true
          npm test || true

      - name: Build frontend (use your build-react script)
        run: |
          npm run build-react

      - name: Add STAGE host to known_hosts
        run: |
          mkdir -p "$HOME/.ssh"
     	  ssh-keyscan -H "${{ secrets.EC2_STAGE_HOST }}" >> "$HOME/.ssh/known_hosts"

      - name: Copy frontend build to STAGE server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.EC2_STAGE_HOST }}
          username: ${{ secrets.EC2_STAGE_USER }}
          key: ${{ secrets.EC2_STAGE_SSH_KEY }}
          port: 22
          source: |
            build/*
          target: /var/www/reactnodetesting

      - name: Copy backend to STAGE server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.EC2_STAGE_HOST }}
          username: ${{ secrets.EC2_STAGE_USER }}
          key: ${{ secrets.EC2_STAGE_SSH_KEY }}
          port: 22
          source: |
            index.js
            package.json
            package-lock.json
            *.js
            *.json
          target: /opt/reactnodetesting/backend

      - name: Restart services on STAGE server
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_STAGE_HOST }}
          username: ${{ secrets.EC2_STAGE_USER }}
          key: ${{ secrets.EC2_STAGE_SSH_KEY }}
          port: 22
          script: |
            set -e
            cd /opt/reactnodetesting/backend || exit 0
            npm ci || true
            if pm2 list | grep -q react-backend; then
              pm2 restart react-backend
            else
              pm2 start index.js --name react-backend || (node index.js &)
            fi
            sudo systemctl restart nginx || true

      - name: Notify on SUCCESS (Staging)
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Deployment SUCCESS (Staging) — ${{ github.repository }} #${{ github.run_number }}"
          body: |
            Push to main was deployed to STAGING.
            URL: http://${{ secrets.EC2_STAGE_HOST }}
            Commit: ${{ github.sha }}
          to: ${{ secrets.QA_EMAIL }},${{ secrets.INSTRUCTOR_EMAIL }}
          from: ${{ secrets.SMTP_USER }}

      - name: Notify on FAILURE (Staging)
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "CI/Deploy FAILED (Staging) — ${{ github.repository }} #${{ github.run_number }}"
          body: |
            The Staging deployment failed. View run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.INSTRUCTOR_EMAIL }},${{ secrets.QA_EMAIL }}
          from: ${{ secrets.SMTP_USER }}
