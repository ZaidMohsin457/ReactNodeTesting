name: CI → Deploy to TESTING

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: ${{ secrets.NODE_VERSION || '18' }}

jobs:
  build-test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (root)
        run: |
          npm i

      - name: Run lint & tests (allow warnings)
        run: |
          npm run lint || true
          npm test || true

      - name: Build frontend (use your build-react script)
        run: |
          npm run build-react

      - name: Get PR author email (try commit author)
        if: github.event_name == 'pull_request'
        run: |
          git fetch --unshallow || true
          AUTHOR_EMAIL=$(git show -s --format='%ae' ${{ github.event.pull_request.head.sha }} || true)
          echo "AUTHOR_EMAIL=${AUTHOR_EMAIL}" >> $GITHUB_ENV
          echo "PR_USER=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV

      - name: Add TEST host to known_hosts
        run: |
          mkdir -p "$HOME/.ssh"
    	  ssh-keyscan -H "${{ secrets.EC2_TEST_HOST }}" >> "$HOME/.ssh/known_hosts"
    
      - name: Copy frontend build to TEST server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.EC2_TEST_HOST }}
          username: ${{ secrets.EC2_TEST_USER }}
          key: ${{ secrets.EC2_TEST_SSH_KEY }}
          port: 22
          source: |
            build/*
          target: /var/www/reactnodetesting

      - name: Copy backend to TEST server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.EC2_TEST_HOST }}
          username: ${{ secrets.EC2_TEST_USER }}
          key: ${{ secrets.EC2_TEST_SSH_KEY }}
          port: 22
          source: |
            index.js
            package.json
            package-lock.json
            *.js
            *.json
          target: /opt/reactnodetesting/backend

      - name: Restart services on TEST server
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_TEST_HOST }}
          username: ${{ secrets.EC2_TEST_USER }}
          key: ${{ secrets.EC2_TEST_SSH_KEY }}
          port: 22
          script: |
            set -e
            cd /opt/reactnodetesting/backend || exit 0
            npm ci || true
            if pm2 list | grep -q react-backend; then
              pm2 restart react-backend
            else
              pm2 start index.js --name react-backend || (node index.js &)
            fi
            sudo systemctl restart nginx || true

      - name: Notify QA on SUCCESS (Testing)
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Deployment SUCCESS (Testing) — ${{ github.repository }} #${{ github.run_number }}"
          body: |
            The PR was built and deployed to TESTING.
            URL: http://${{ secrets.EC2_TEST_HOST }}
            PR: ${{ github.event.pull_request.html_url }}
          to: ${{ secrets.QA_EMAIL }}
          from: ${{ secrets.SMTP_USER }}

      - name: Notify on FAILURE (Testing)
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "CI/Deploy FAILED (Testing) — ${{ github.repository }} #${{ github.run_number }}"
          body: |
            The CI/Deploy run failed for PR: ${{ github.event.pull_request.html_url }}
            View run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.INSTRUCTOR_EMAIL }},${{ env.AUTHOR_EMAIL }}
          from: ${{ secrets.SMTP_USER }}
